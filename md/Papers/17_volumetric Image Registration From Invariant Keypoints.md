# Volumetric Image Registration From Invariant Keypoints

## 1. Introduction
提出了一种基于三维尺度和旋转不变量关键点的图像配准方法。该方法通过对方向分配和梯度直方图进行关键修改，将尺度不变特征变换(SIFT)扩展到任意维。用数学方法证明了旋转不变性。根据图像配准的要求，对极值检测和关键点匹配进行了改进。实验表明，离散极值检测中邻域的选择对图像配准精度有很大影响。


## 2. Related Work
提出了一种基于结构张量特征分解的方向估计方法，并证明了该方法可以考虑任意维数的任意旋转。此外，我们将梯度直方图建立在正二十面体上，通过三角形面的重心坐标插值直方图容器之间的贡献，以一种几何上合理的方式减轻量化影响。据我们所知，这些方法以前没有用于三维关键点，并解决了以前工作的数学问题。


## 3. Keypoint Detection And Description

从图像中提取关键点有两个步骤。
- 首先需要检测出能够在对图像之间可靠匹配的点。
- 第二步是在以每个点为中心的窗口中生成描述图像内容的特征向量。生成的特征向量，称为“描述符”，对基础图像的膨胀、旋转和平移近似不变。

下面将对这些方法进行总结，与SIFT算法相似，SIFT算法最初是为二维图像定义的。

<div align="center"><img src="https://img-blog.csdnimg.cn/3f53353d241c415f9f3b34256feb9c64.png
" width="60%" alt=""></div>

在高斯金字塔上来计算DoG，在尺度和空间上搜索图像的局部极值。例如在图像一个像素点的四邻域内进行比较，判断是否是局部极值，如果是局部极值，则可能是关键点。

### 3.1 Keypoint Locations
候选关键点位置的获取方法与原始SIFT算法基本相同。为了近似的尺度不变性，我们寻找图像空间坐标和高斯尺度参数 $σ$ 的最大值。向量 $(x，σ)$ 称为“尺度空间”坐标。要最大化的函数是图像与高斯函数的拉普拉斯算子的卷积
$$l(x, σ) = I(x) \ast \nabla g_σ(x), \ \ \ \ \ \ \ \ \  (1)$$

其中，$σ(x)$ 是参数 $σ$ 的高斯函数。这是近似的卷积与差分高斯函数(DoG)
$$ d(x,σ)=I(x)∗(g_σ+δ(x)−g_σ(x)), \ \ \ \ \ \ \ \ \ \  (2)$$

其中 $δ$ 是一个小常数。DoG函数是通过减去高斯尺度空间金字塔的连续层次来计算的。

$d(x，σ)$ 的极值形成了初始的候选关键点。以往的作者通常将极值定义为$(3^n−1)$ $l^{\infty}$ 连通域，我们用2n连通?如图1所示。这些邻域在细胞自动机理论中分别被称为摩尔邻域和冯·诺伊曼邻域。用这种方法来定义极值，有助于从理论上解释一个点是一个 $l^1$ 只有当它是其前向差分的一个平稳点时才有极值。虽然这导致极值的数目和必要的计算量有了相当大的增加，但它却产生了更多的正确匹配的关键点。

在找到最初的候选点后，我们拒绝了那些规模弱小的候选点。形式上，我们拒绝一个 $(x，σ)$，如果
$$|d(x,σ)|< α\ max_{X,σ}|d(x,σ)|, \ \ \ \ \ \ \ \ \ \  (3)$$

其中α为常数参数。这与原始SIFT公式略有不同，因为方程3中的最大项调整阈值以适应我们的数据的对比度。与原始SIFT不同，我们没有将关键点坐标插值到亚体素精度，因为在我们的实验中，这未能提高匹配稳定性。

### 3.2 Local Orientations and Corner Detection

为了构造旋转不变的特征描述符，通常的做法是给每个关键点分配一个可重复的方向。通过根据其方向的逆旋转加窗图像，使特征描述符对其对象的旋转不变性。

二维中的关键点检测算法通常为每个关键点指定一个角度 $θ$，由此计算旋转矩阵。在SIFT中，$θ$ 是根据关键点周围窗口中计算的梯度直方图模式来选择的。事实上，二维是一个特例，这种方法不能推广到高维。n维中的旋转矩阵 $R$ 是正交矩阵，而且 $|R|=1$，类似于二维情况，这种矩阵可以由Euler角的三角函数构成。但(n−1)球坐标只产生 $n−1$ 角。因此，我们不能通过从梯度直方图中只选择一个向量来定义方向。尽管如此，Scovanneret al.使用球坐标给出的两个欧拉角来生成三维中的旋转矩阵，承认这种方法并不适用于一般情况。因此，3D SIFT之前的很多工作都不是旋转不变的。

Allaireet al.绕过了这个问题，首先从梯度直方图中选择一个向量，然后通过原点在其平面上计算一个额外的直方图。在三维中，找到这个次级直方图的模式相当于计算关于第一个向量的“滚动”。除了计算损失外，该方法还存在一个问题，即用直方图的bin角进行量化。方向分配的一个简单的替代方法是，各向同性，适用于任何维度，利用梯度分量之间的相关性，也称为结构张量，
$$K = \int w(x)∇I(x)(∇I(x))^Tdx, \ \ \ \ \ \ \ \ \ \  (4) $$
其中: $∇I(x)$ 为图像 $I$ 在位置 $x$ 的梯度，用有限差分近似，$w(x)$ 为以关键点为中心的高斯窗口，其宽度为关键点尺度的常数倍。

结构张量是 `Hermitian`（完全不知道是什么），因此它有一个正交特征分解，$K=Q \bigwedge Q^T$。如果特征值是有序且不同的，则分解是唯一的。图2给出了结构张量及其特征向量的图解解释。这个矩阵在计算机视觉中是众所周知的，特别是在角点检测方面。Kandelet al.利用这些特征向量对图像补丁进行对齐。在这项工作中，我们使用它们来推导每个关键点的局部方向，避免了成对对齐的需要。 

<div align="center"><img src="https://img-blog.csdnimg.cn/291d98be31a44fa4b48ac82349e00b70.png
" width="60%" alt=""></div>

矩阵 $Q$ 本身不能给出一个鲁棒的方向，因为它对于沿每个轴的变化方向是模糊的。考虑到这一点，认为 $Q$ 对 $-∇I$ 不变。为了实现旋转不变性，需要引入更多的信息。一个很自然的选择是计算沿着每个向量 $q_i$, $Q$ 的第 $i$ 列的变化方向，
$$d = \int w(x)∇I(x)dx$$ $$s_i=sgn(q^T_id).$$

我们通过要求每个特征向量的方向导数是正的来计算 $R$。

---
此处省略一大堆文字………………

---

整体来说去除关键点有两个规则
- 结构张量的特征值按升序排列，如果满足下式的话，就去除该关键点
$$ max_i |\frac{λ_i}{λ_{i+1}}| > β $$
- 计算图像梯度与特征向量的角度。 如果满足下式的话，就去除该关键点
$$min_i|cos(θ_i)|< γ$$


### 3.3  Gradient Histograms

我们将其称为 `“globe”` 方法，因为箱子之间的边与 `globe` 中的经度和纬度线相同。正如Scovanneret al.所指出的，这个直方图在三维中是向某些方向倾斜的。这个问题可以通过将梯度直方图看作单位(n−1)球面的镶嵌来看到。在这里，梯度向量被分配到与共享方向和原点的射线相交的bin。如图3所示，球体产生不同形状的切片。

<div align="center"><img src="https://img-blog.csdnimg.cn/7b9b1050df1c4e9e8b8a9bb54ca0d408.png
" width="60%" alt=""></div>

很明显，我们必须将(n - 1)球面划分成相等的块，每个顶点关联到相同数量的块。满足这些约束条件的凸多面体数目取决于n

对于检测出来的关键点，我们选择正二十面体，在该二十面体区域中计算梯度大小值和方向。 通过二十面体的十二个顶点来表示柱，实现： 对二十面体中相交三角形的三个顶点的梯度向量进行加权累加生成一个柱，这样一共就生成十二个柱。

为了计算关键点描述符，也称为特征向量，我们首先取一个以关键点为中心的球形图像窗口，半径为 $2σ$， $σ$ 是方程2中关键点尺度的常数倍。为了实现旋转不变性，通过对III-B节关键点方向的逆来旋转图像。然后将球形窗口划分为 $4×4×4$ 数组的立方体子区域，如图5所示。每个子区域计算一个单独的梯度直方图，每个直方图有12个顶点，总共有$43·12=768$ 个分量。使用高斯窗，每个体素的贡献由一个尺度 $σ$ 的高斯函数加权，该函数基于其到关键点的距离。为了避免量化，每个体素的贡献通过其相交三角形的三个顶点之间的重心坐标分布，以及在立方体中包围体素的八个子区域中心之间的三线性插值分布。


<div align="center"><img src="https://img-blog.csdnimg.cn/a5ff7392f7e44975b92ee02fce926c04.png
" width="60%" alt=""></div>

二维三线性插值的可视化。坐标系统居中并围绕关键点 $k$ 旋转。描述子在半径为 $2σ$ 的窗口内计算。梯度的大小是根据它与子区域中心的距离加权的，子区域中心在一个正方形中包围。在三维空间中，有八个分区围在一个立方体中。

### 3.4 Geometric Moment Invariants

## 4. Keypoint Matching And Image registration

<div align="center"><img src="https://img-blog.csdnimg.cn/ee3bfd88c11940a3a858860b876f7650.png
" width="60%" alt=""></div>