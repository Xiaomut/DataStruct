## Large Deformation Diffeomorphic Image Registration with Laplacian Pyramid Networks

### 1. 介绍
传统深度学习无监督方法配准的缺点:
1. 在最优分辨率的相似度度量的梯度一般是粗糙的，因为运动图像的许多可能的变换可以产生相似的度量。
2. 由于变换参数的自由度较大，不进行初始化变换的优化问题在最优解时很难求解

相应的解决方式有:
- 多个cnn叠加用于直接仿射和可变形图像配准
- 端到端递归级联网络逐步细化配准结果，结果可能是次最优的，因为相似度的梯度在最优分辨率下可能是粗糙的

这些方法完全忽略了理想的变换的微分形特性，这进一步限制了它们的临床应用潜力。


- 提出了一种新的用于大变形图像配准的LapIRN，该方法利用了多分辨率策略的优势，同时在从粗到细的优化方案中保持了特征图的非线性;
- 为金字塔网络提出一种新的金字塔相似性度量，以捕获输入扫描之间的大小偏差，有助于避免优化过程中的局部极小值;
- 给出了我们方法的一个有效的微分同态集合，并证明了我们的方法保证了理想的微分同态性质，包括计算的变换的可逆性和拓扑保持。

### 2. 方法

利用三个相同的基于CNN的配准网络来模拟多分辨率模式下的配准

<div align="center"><img src="https://img-blog.csdnimg.cn/2f85e38432384e238fbee71161b26b63.png
" width="60%" alt=""></div>

#### 2.1 Deep Laplacian Pyramid Image Registration Networks


##### 2.1.1 Network architecture（网络结构）

`LapIRN`: L阶的拉普拉斯金字塔，论文中设为3，也就是通过三线性插值分别得到三对图像，大小分别缩小一倍

对于第一个金字塔级，CRN(CNN-based registration network) 以最粗糙的分辨率捕获来自串联输入扫描的非线性失调，输出3通道密集矢量场 $v_1$ 和变形场 $φ_1$，当金字塔层级大于1时，从上一级的金字塔的输出形变场进行2倍上采样，并得到一个配准图像（浮动图像经过采样后的形变场的输出）。然后，我们也从上一级 $v_{i−1}$ 的输出速率场2倍上采样(表示为 $v_{i−1}$) ，并将其与输入( $F_i$ 和 $M_i(φ_{i−1})$)合起来，作为5通道的第 $i$ 级金字塔的输入（对应结构图中右侧黑色向上箭头）。最后，将输出的速率场与$v_{i−1}$ 上采样相加，得到并积分得到金字塔水平面的最终变形场 $φ_i$。低层CRN的特征嵌入通过跳跃连接添加到下一层，这大大增加了接受域和网络的非线性，以学习更精细的层次的复杂非线性对应。

##### 2.1.2 CNN-based Registration Network（基于CNN的配准网络）

`CRN 构成: `
- a feature encoder
- a set ofRresidual blocks
- a feature decoder

特征编码器由两个 $stride$ 为1的3D卷积层和一个 $stride$ 为2的3D卷积层组成，每个CRN使用5个残块，每个CRN包含两个3D卷积层，具有预激活结构（Identity mappings in deep residual networks）和跳层连接。最后，在尾部添加一个转置卷积层和两个连续3D卷积层的特征解码模块，激活函数为SoftSign，输出速率场。在特征编码器与特征解码器之间增加了跳层连接，以防止在学习变形场时低级特征的消失。在CRN中，除了输出卷积层，每个卷积层有28个滤波器，然后是LeakyReLU，斜率为-0.2。

##### 2.1.3 Coarse-to-fine Training（由粗到细的训练）

端到端训练对于LapIRN并不是一个理想的训练方案，因为在不同分辨率之间很难平衡多重损失的权重。首先从最粗糙的层次单独训练CRN，然后我们逐步添加下一层次的CRN，以更好的分辨率学习图像配准问题。为了避免不稳定的热启动，当一个新的CRN被添加到训练中时，我们将所有预训练CRN的学习参数冻结持续一个常量 $M$ 的steps。我们设置 $M=2000$ ，并重复训练直到最优。


#### 2.2 Similarity Pyramid

用基于强度的相似性度量在最优分辨率上解决图像配准问题通常会得到局部最小解。利用完美对齐的图像对将在所有分辨率中产生高相似值这一事实，我们提出了一个相似度金字塔框架来解决这一挑战。虽然提出的相似度金字塔框架适用于许多相似度测量，但为了简单起见，我们使用局部归一化互相关(NCC)来表述它。提出的相似度金字塔可以表示为:

<div align="center"><img src="https://img-blog.csdnimg.cn/71158a3570a74211bb42da05419634ce.png
" width="50%" alt=""></div>

$S^K$ 是第 $K$ 阶的相似度。对分辨率较低的相似度赋一个较低的权重，以防止低级相似度占主导地位。我们在实现中设置 $w = 1 + 2i$ 。提出的相似度金字塔以多分辨率的方式捕捉相似度。由于在较粗的分辨率下，相似性度量更平滑，对噪声的敏感性更低，从较低的层次积分相似性度量有助于避免在高分辨率优化问题中出现局部极小值。

<div align="center"><img src="https://img-blog.csdnimg.cn/a3a683bca47e468daa86745243f6b101.png
" width="50%" alt=""></div>


$p$ 是金字塔层级，第二项是速率场 $v$ 的平滑正则化，$λ$ 是正则化参数。

#### 2.3 Diffeomorphic Deformation

$$φ(x) =x+u(x)$$
这个是之前很常用的位移场对变形模型进行参数化，$x$ 表示恒等变换


### 3. 实验

OASIS + LPBA40，144×192×160

评价指标: Dice等（好多....）


### 4. 链接
[1] Mok T ,  Chung A . Large Deformation Diffeomorphic Image Registration with Laplacian Pyramid Networks[M].  2020.
[2] [源码](https://github.com/cwmok/LapIRN)


---

#### To Be Continued...